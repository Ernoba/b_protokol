<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhotoboothSongo by Ernoba</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Tema Ernoba */
            --primary: #4A90E2;
            --accent: #FF6B6B;
            --bg-body: #F7F9FC;
            --text-main: #2C3E50;
            --radius: 20px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background: #000; /* Background hitam agar seamless */
            font-family: 'Poppins', sans-serif;
            color: var(--text-main);
            /* PERBAIKAN LAYOUT: Gunakan dvh untuk mobile */
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            position: fixed; /* Kunci posisi agar tidak scroll */
            inset: 0;
        }

        /* --- SLIDER SYSTEM --- */
        .main-container {
            display: flex;
            width: 300%; /* 3 Halaman */
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            transform: translateX(-33.33%); /* Mulai di tengah (33.33% dari 300% = 1 layar) */
        }

        .page {
            width: 100vw; /* Lebar relatif terhadap viewport */
            height: 100%;
            flex-shrink: 0; /* Jangan mengecil */
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- HALAMAN 1: AUTHOR --- */
        .page-author {
            background: var(--bg-body);
            justify-content: center; align-items: center; text-align: center;
            padding: 20px;
        }
        .author-card {
            background: #fff; padding: 30px; border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 350px; width: 100%;
        }
        .tech-stack { display: flex; gap: 8px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        .tech-badge { background: #EEF2F7; padding: 5px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }

        /* --- HALAMAN 2: KAMERA --- */
        .page-camera { background: #000; }
        
        /* Video Container: Memastikan video proporsional tapi memenuhi layar */
        .video-container {
            position: relative;
            width: 100%;
            flex: 1; /* Isi sisa ruang */
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        video {
            width: 100%; height: 100%; object-fit: cover;
        }

        /* UI Overlay Kamera */
        .camera-header {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 20px; z-index: 20;
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
        }
        .brand-pill {
            background: rgba(255,255,255,0.9); padding: 6px 14px;
            border-radius: 20px; font-weight: 700; font-size: 0.85rem;
        }
        .icon-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.3);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; backdrop-filter: blur(4px);
        }

        .camera-controls {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 30px 20px 50px 20px; /* Padding bawah extra untuk safe area */
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 20;
        }
        
        .shutter-outer {
            width: 80px; height: 80px; border-radius: 50%;
            border: 4px solid white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; background: rgba(255,255,255,0.1);
        }
        .shutter-inner {
            width: 65px; height: 65px; background: white; border-radius: 50%;
            transition: 0.2s;
        }
        .shutter-outer:active .shutter-inner { transform: scale(0.9); background: var(--primary); }

        .flash-overlay {
            position: fixed; inset: 0; background: white;
            opacity: 0; pointer-events: none; z-index: 100; transition: opacity 0.1s;
        }

        /* Navigasi Hint */
        .nav-hint {
            position: absolute; top: 50%; transform: translateY(-50%);
            color: rgba(255,255,255,0.5); font-size: 1.5rem; padding: 20px; z-index: 15; cursor: pointer;
        }
        .nav-left { left: 0; }
        .nav-right { right: 0; }

        /* --- HALAMAN 3: GALERI --- */
        .page-gallery { background: var(--bg-body); height: 100%; display: flex; flex-direction: column; }
        .gallery-header {
            padding: 20px; background: white; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10;
        }
        .gallery-grid {
            flex: 1; overflow-y: auto; padding: 15px;
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            align-content: start;
        }
        .photo-card {
            background: white; border-radius: 12px; overflow: hidden; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); animation: popIn 0.3s ease;
        }
        .photo-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .del-badge {
            position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5);
            color: white; width: 25px; height: 25px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
        }
        
        .gallery-footer {
            padding: 20px; background: white; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            display: flex; gap: 10px;
        }
        .btn-main {
            flex: 1; background: var(--primary); color: white; border: none;
            padding: 15px; border-radius: 15px; font-weight: 700; font-size: 1rem;
        }

        /* --- MODAL --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box { background: white; width: 85%; max-width: 320px; padding: 25px; border-radius: 20px; }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin: 10px 0; outline: none; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="main-container" id="mainContainer">
        
        <div class="page page-author">
            <div class="author-card">
                <i class="fas fa-camera-retro" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                <h2>PhotoboothSongo</h2>
                <p style="color:#777; font-size:0.9rem;">Created by <b>Ernoba Creative</b></p>
                <div class="tech-stack">
                    <span class="tech-badge">Python Flask</span>
                    <span class="tech-badge">JS Canvas</span>
                    <span class="tech-badge">Walisongo Sragen</span>
                </div>
                <button class="btn-main" onclick="slide(1)" style="margin-top:20px; width:100%;">
                    Mulai Foto <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div class="page page-camera">
            <div class="camera-header">
                <div class="icon-btn" onclick="toggleSettings()"><i class="fas fa-cog"></i></div>
                <div class="brand-pill">ERNOBA</div>
                <div class="icon-btn" id="connIcon" style="background: #ff4757;"><i class="fas fa-wifi"></i></div>
            </div>

            <div class="video-container">
                <video id="videoFeed" autoplay playsinline muted></video>
                <div id="countdownDisplay" style="position: absolute; font-size:8rem; color:white; font-weight:800; display:none; text-shadow: 0 5px 20px rgba(0,0,0,0.5);">3</div>
            </div>

            <div class="nav-hint nav-left" onclick="slide(0)"><i class="fas fa-chevron-left"></i></div>
            <div class="nav-hint nav-right" onclick="slide(2)"><i class="fas fa-images"></i></div>

            <div class="camera-controls">
                <div class="icon-btn" onclick="switchCamera()" style="width:50px; height:50px; background:rgba(255,255,255,0.2);">
                    <i class="fas fa-sync-alt"></i>
                </div>
                
                <div class="shutter-outer" onclick="startCaptureSequence()">
                    <div class="shutter-inner"></div>
                </div>

                <div class="icon-btn" onclick="toggleTimer()" id="timerBtn" style="width:50px; height:50px; background:rgba(255,255,255,0.2);">
                    <span style="font-weight:bold; font-size:0.8rem;">OFF</span>
                </div>
            </div>
        </div>

        <div class="page page-gallery">
            <div class="gallery-header">
                <h3>Galeri</h3>
                <span id="photoCount" style="color:var(--primary); font-weight:bold;">0 Foto</span>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                </div>
            <div class="gallery-footer">
                <button class="icon-btn" onclick="slide(1)" style="background:#eee; color:#333; width:60px; border-radius:15px;"><i class="fas fa-camera"></i></button>
                <button class="btn-main" onclick="uploadAllPhotos()" id="uploadBtn">
                    Kirim ke Server <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="flash" class="flash-overlay"></div>

    <div class="modal" id="settingsModal">
        <div class="modal-box">
            <h3>Konfigurasi</h3>
            <label style="font-size:0.8rem; color:#666;">IP Server Python:</label>
            <input type="text" id="serverIpInput" class="input-box" placeholder="192.168.x.x">
            <div style="display:flex; gap:10px;">
                <button class="btn-main" style="background:#ddd; color:#333;" onclick="toggleSettings()">Batal</button>
                <button class="btn-main" onclick="saveSettings()">Simpan</button>
            </div>
        </div>
    </div>

    <canvas id="captureCanvas" style="display:none;"></canvas>

    <script>
        // --- STATE ---
        let stream = null;
        let facingMode = 'user'; // Default kamera depan
        let photos = [];
        let timerSeconds = 0;
        let serverIp = localStorage.getItem('ernoba_ip') || '';
        let viewIndex = 1;

        // --- INIT ---
        window.addEventListener('load', () => {
            initCamera(); // Start kamera langsung
            updateConnIcon();
            
            // SWIPE GESTURE
            let touchX = 0;
            document.body.addEventListener('touchstart', e => touchX = e.changedTouches[0].screenX);
            document.body.addEventListener('touchend', e => {
                const diff = touchX - e.changedTouches[0].screenX;
                if(Math.abs(diff) > 50) { // Threshold
                    if(diff > 0 && viewIndex < 2) slide(viewIndex + 1);
                    if(diff < 0 && viewIndex > 0) slide(viewIndex - 1);
                }
            });
        });

        function slide(idx) {
            viewIndex = idx;
            // 33.33% karena width container 300%
            const translate = -(idx * 33.333); 
            document.getElementById('mainContainer').style.transform = `translateX(${translate}%)`;
        }

        // --- CAMERA SYSTEM (UPDATED) ---
        async function initCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            const video = document.getElementById('videoFeed');
            
            // Prioritas: Facing Mode (Depan/Belakang) daripada Device ID
            // Kita coba resolusi tinggi dulu, kalau gagal catch error dan turunkan
            const constraints = {
                audio: false,
                video: {
                    facingMode: facingMode, // 'user' atau 'environment'
                    width: { ideal: 1920 }, // Full HD (Aman untuk mobile)
                    height: { ideal: 1080 }
                }
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Mirror effect hanya untuk kamera depan
                video.style.transform = (facingMode === 'user') ? "scaleX(-1)" : "none";

            } catch (err) {
                console.warn("Gagal HD, coba resolusi rendah...", err);
                try {
                    // Fallback ke resolusi standar jika HP kentang
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: facingMode }
                    });
                    video.srcObject = stream;
                    video.style.transform = (facingMode === 'user') ? "scaleX(-1)" : "none";
                } catch (e) {
                    alert("Kamera tidak dapat diakses. Pastikan izin browser aktif.");
                }
            }
        }

        function switchCamera() {
            // Toggle mode
            facingMode = (facingMode === 'user') ? 'environment' : 'user';
            initCamera();
        }

        function toggleTimer() {
            const arr = [0, 3, 5, 10];
            let idx = arr.indexOf(timerSeconds);
            timerSeconds = arr[(idx + 1) % arr.length];
            
            const btn = document.getElementById('timerBtn');
            btn.innerHTML = timerSeconds === 0 
                ? 'OFF' 
                : `<span style="color:var(--primary)">${timerSeconds}s</span>`;
        }

        // --- CAPTURE LOGIC ---
        function startCaptureSequence() {
            if(timerSeconds > 0) {
                let count = timerSeconds;
                const disp = document.getElementById('countdownDisplay');
                disp.innerText = count;
                disp.style.display = 'block';
                
                const interval = setInterval(() => {
                    count--;
                    if(count > 0) {
                        disp.innerText = count;
                    } else {
                        clearInterval(interval);
                        disp.style.display = 'none';
                        takePicture();
                    }
                }, 1000);
            } else {
                takePicture();
            }
        }

        function takePicture() {
            // Efek Flash
            const flash = document.getElementById('flash');
            flash.style.opacity = 1;
            setTimeout(() => flash.style.opacity = 0, 100);

            const video = document.getElementById('videoFeed');
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');

            // Sesuaikan canvas dengan ukuran asli video stream
            const w = video.videoWidth;
            const h = video.videoHeight;
            canvas.width = w;
            canvas.height = h;

            // Logika Mirroring pada Canvas (PENTING)
            // Jika kamera depan, kita harus flip canvas agar hasil foto sesuai preview
            if (facingMode === 'user') {
                ctx.translate(w, 0);
                ctx.scale(-1, 1);
            }

            ctx.drawImage(video, 0, 0, w, h);

            // Simpan gambar
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const id = Date.now();
                photos.push({ id, blob, url });
                renderGallery();
                
                // Feedback visual kecil
                document.querySelector('.nav-right').style.color = 'var(--primary)';
                setTimeout(()=>document.querySelector('.nav-right').style.color = 'rgba(255,255,255,0.5)', 500);
            }, 'image/jpeg', 0.95);
        }

        // --- GALLERY & UPLOAD ---
        function renderGallery() {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = '';
            document.getElementById('photoCount').innerText = `${photos.length} Foto`;

            [...photos].reverse().forEach(p => {
                const el = document.createElement('div');
                el.className = 'photo-card';
                el.innerHTML = `
                    <img src="${p.url}">
                    <div class="del-badge" onclick="deletePhoto(${p.id})">âœ•</div>
                `;
                grid.appendChild(el);
            });
        }

        function deletePhoto(id) {
            if(!confirm("Hapus?")) return;
            photos = photos.filter(p => p.id !== id);
            renderGallery();
        }

        async function uploadAllPhotos() {
            if (!serverIp) return alert("Set IP Server dulu di ikon Gerigi.");
            if (photos.length === 0) return alert("Galeri kosong.");

            const btn = document.getElementById('uploadBtn');
            const oriTxt = btn.innerHTML;
            btn.innerHTML = 'Mengirim...';
            btn.disabled = true;

            const formData = new FormData();
            photos.forEach(p => formData.append('files[]', p.blob, `foto_${p.id}.jpg`));

            try {
                // Asumsi endpoint Python Flask di /upload
                const res = await fetch(`http://${serverIp}/upload`, {
                    method: 'POST',
                    body: formData
                });
                if(res.ok) {
                    alert("Terkirim Sukses!");
                    photos = [];
                    renderGallery();
                    slide(1);
                } else {
                    alert("Gagal kirim ke server.");
                }
            } catch (e) {
                alert("Error koneksi: " + e.message);
            } finally {
                btn.innerHTML = oriTxt;
                btn.disabled = false;
            }
        }

        // --- SETTINGS ---
        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            if(m.style.display === 'flex') m.style.display = 'none';
            else {
                document.getElementById('serverIpInput').value = serverIp;
                m.style.display = 'flex';
            }
        }
        function saveSettings() {
            serverIp = document.getElementById('serverIpInput').value;
            localStorage.setItem('ernoba_ip', serverIp);
            toggleSettings();
            updateConnIcon();
        }
        function updateConnIcon() {
            document.getElementById('connIcon').style.background = serverIp ? '#2ecc71' : '#ff4757';
        }
    </script>
</body>
</html>